# Job Templates für GitLab CI/CD
# Diese Templates (dot-jobs) können von anderen Jobs mit 'extends' genutzt werden

# Base Template für alle Jobs
.base_job:
  image: ubuntu:22.04
  tags:
    - docker
  before_script:
    - echo "Starting job at $(date)"
    - apt-get update -qq
  after_script:
    - echo "Job finished at $(date)"
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

# Docker Build Template
.docker_build:
  extends: .base_job
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
    DOCKER_DRIVER: overlay2
  before_script:
    - docker info
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG .
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG

# Python Test Template
.python_test:
  extends: .base_job
  image: python:3.11-slim
  before_script:
    - pip install --upgrade pip
    - pip install pytest pytest-cov pylint black flake8
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - .pip-cache/
  artifacts:
    when: always
    reports:
      junit: report.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    expire_in: 30 days

# Node.js Build Template
.nodejs_build:
  extends: .base_job
  image: node:18-alpine
  before_script:
    - node --version
    - npm --version
    - npm ci
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
  artifacts:
    paths:
      - dist/
      - build/
    expire_in: 1 week

# Deployment Template
.deploy_template:
  extends: .base_job
  only:
    - main
    - master
    - /^release\/.*$/
  environment:
    name: $DEPLOY_ENV
    url: https://$DEPLOY_ENV.example.com
  before_script:
    - echo "Deploying to $DEPLOY_ENV environment"
    - apt-get install -y openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "$SSH_KNOWN_HOSTS" >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts

# Security Scan Template
.security_scan:
  extends: .base_job
  image: aquasec/trivy:latest
  variables:
    TRIVY_NO_PROGRESS: "true"
    TRIVY_CACHE_DIR: ".trivycache/"
  cache:
    paths:
      - .trivycache/
  allow_failure: true
  artifacts:
    reports:
      container_scanning: gl-container-scanning-report.json
    expire_in: 7 days

# Code Quality Template
.code_quality:
  extends: .base_job
  image: sonarsource/sonar-scanner-cli:latest
  variables:
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"
    GIT_DEPTH: "0"
  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - .sonar/cache
  only:
    - merge_requests
    - main
    - develop

# Performance Test Template
.performance_test:
  extends: .base_job
  image: grafana/k6:latest
  artifacts:
    reports:
      performance: performance.json
    expire_in: 7 days
  allow_failure: true

# Notification Template
.notify:
  extends: .base_job
  image: curlimages/curl:latest
  when: on_failure
  script:
    - |
      curl -X POST $SLACK_WEBHOOK_URL \
        -H 'Content-Type: application/json' \
        -d "{\"text\":\"Pipeline failed for $CI_PROJECT_NAME on branch $CI_COMMIT_REF_NAME\"}"
  only:
    - main
    - master

# Database Migration Template
.db_migration:
  extends: .base_job
  image: postgres:15-alpine
  before_script:
    - apk add --no-cache postgresql-client
  variables:
    PGHOST: $DB_HOST
    PGUSER: $DB_USER
    PGPASSWORD: $DB_PASSWORD
    PGDATABASE: $DB_NAME
  only:
    - main
    - develop
  when: manual
