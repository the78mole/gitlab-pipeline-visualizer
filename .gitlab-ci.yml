stages:
  - build
  - test
  - deploy

variables:
  DOCKER_IMAGE: myapp:latest

build:docker:
  stage: build
  script:
    - docker build -t $DOCKER_IMAGE .

build:npm:
  stage: build
  script:
    - npm install
    - npm run build

test:unit:
  stage: test
  needs: [build:npm]
  script:
    - npm test

test:integration:
  stage: test
  needs: 
    - build:docker
    - build:npm
  script:
    - pytest tests/integration/

test:e2e:
  stage: test
  needs: [build:docker]
  script:
    - npm run test:e2e

deploy:staging:
  stage: deploy
  needs:
    - test:unit
    - test:integration
  script:
    - kubectl apply -f k8s/staging/
  environment:
    name: staging

deploy:production:
  stage: deploy
  needs: [deploy:staging, test:e2e]
  script:
    - kubectl apply -f k8s/production/
  environment:
    name: production
  when: manual
